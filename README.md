# AIChallenge

AIChallenge — Android-приложение на Jetpack Compose для общения с локальными и облачными LLM, демонстрации MCP-инструментов и работы с несколькими профилями пользователей. Клиент может переключаться между локальным сервером (Yandex GPT 5.1), Hugging Face Router API, а также запускать встроенные MCP-серверы, которые выступают источниками знаний и инструментов.

## Основные возможности
- **Yandex Chat (LocalAiServer).** Локальный HTTP/WS сервер на NanoHTTPD, который принимает запросы /chat, /history, /clear и умеет вызывать MCP_TOOL из ответа модели.
- **Hugging Chat.** Альтернатива, отправляющая запросы в Hugging Face Router API, с тем же UI.
- **MCP Tools.** Запуск и мониторинг двух MCP-серверов (core и knowledge), просмотр списка инструментов и ручные вызовы из UI.
- **Профили пользователей.** Локальное хранилище с именем, языком, тоном, интересами и т.д.; выбранный профиль автоматически подмешивается в промпт.
- **Голосовой ввод.** Кнопка микрофона рядом с отправкой сообщения, распознавание речи через `android.speech.SpeechRecognizer`, полупрозрачный оверлей «Говорите…» и мгновенная отправка результата в чат.

## Архитектура и ключевые модули
- `MainActivity` управляет навигацией между стартовым экраном, чатами, MCP-экранами и профилями.
- Пакет `chat` содержит `ChatScreen`, `ChatViewModel` и модели сообщений. ViewModel работает с `ApiModule.localApi`, хранит историю и управляет WebSocket-подпиской для issue summary.
- Пакет `server` держит реализации `LocalAiServer` и `HuggingFaceLocal`, модели ответов и enum `Model`.
- Пакет `mcp` запускает SSE-серверы (`McpServerManager`, `LocalKnowledgeMcpServerManager`), а `ToolsScreen` позволяет просматривать и вызывать инструменты.
- Пакет `user` реализует репозиторий профилей (`filesDir/user_profiles.json`) и соответствующий экран.

## Локальный сервер (LocalAiServer)
- Основан на NanoHTTPD, слушает `http://127.0.0.1:8080`.
- Эндпоинты: `POST /chat`, `GET /history`, `POST /clear`, `GET /issueSummary` (WS).
- Умеет подмешивать историю до 10 сообщений, подключать MCP_TOOL из ответа модели и отправлять issue summary через WebSocket (по желанию).
- Настройки API-ключей берутся из `local.properties`: `YANDEX_API_KEY`, `YC_FOLDER_ID`.

## Hugging Chat
- `HuggingFaceLocal` проксирует запросы в `https://router.huggingface.co/v1/chat/completions`.
- Использует токен `HF_TOKEN` из `local.properties`.
- Чат-экран и ViewModel переиспользуются, различается только сервер.

## MCP-инфраструктура
- `McpServers` запускает две инстанции: `core` (инструменты GitHub и кампаний) и `knowledge` (данные для D&D).
- `McpClient` оборачивает HTTP-вызовы инструментов и выдаёт список доступных действий в UI.
- `ToolsScreen` отображает инструменты, их параметры и результаты вызова.

## Профили пользователей
- Экран `UserProfilesScreen` позволяет создавать, редактировать и выбирать профиль.
- Данные сохраняются локально, выбранный профиль через `UserProfileRepository` попадает в каждое обращение к LLM.

## Голосовой ввод
- Поле ввода в `ChatScreen` многострочное (до 4 строк), чтобы длинные промпты не закрывались при наборе.
- Рядом расположены две круглые кнопки: микрофон запускает распознавание речи, стрелка отправляет сообщение (со спиннером во время ожидания ответа).
- При первом нажатии микрофона запрашивается разрешение `RECORD_AUDIO`; после подтверждения запись стартует автоматически.
- Распознавание выполняется через `SpeechRecognizer`: на время записи отображается затемненный оверлей с пульсирующей иконкой микрофона и подписью «Говорите…», сообщая об активном состоянии.
- Как только результат готов, текст подставляется в поле ввода и мгновенно отправляется в чат.

## Сборка и запуск
1. Установите Android Studio Hedgehog+, JDK 11 и Android SDK 36.
2. Создайте `local.properties` с ключами:
   ```
   YANDEX_API_KEY=...
   YC_FOLDER_ID=...
   HF_TOKEN=...
   GITHUB_TOKEN=...
   ```
3. Соберите приложение: `./gradlew assembleDebug` или запустите Run в Android Studio.
4. На стартовом экране выберите нужный сценарий:
   - **Yandex Chat** — запускает `LocalAiServer` и открывает основной чат.
   - **Hugging Chat** — подключает `HuggingFaceLocal`.
   - **MCP Tools** — даёт список инструментов и результаты их работы.
   - **Данные пользователя** — управление профилями.
   - Кнопка запуска/остановки MCP запускает оба сервера core/knowledge.

